Техническая документация

1. Архитектура
- Aiogram 3.x (async) + async SQLAlchemy + PostgreSQL.
- Основной бот: bot/app.py; конфиг: bot/config.py; модели: bot/models.py; клавиатуры: bot/keyboards.py; статусы: bot/constants.py; FSM: bot/states.py; отчёты: bot/services/reports.py; фото: bot/services/photos.py; метрики: bot/metrics.py.
- БД таблицы: users (public_id, is_admin), orders (user_order_number, статус, поля заявки, ссылки, communication), order_status_logs (история статусов), order_photos (байтовое хранение), kind_keywords (словарь «вид» → ключевые слова), admin_actions, macro_templates.

2. Нумерация и статусы
- Пользовательский номер: {public_id}-{user_order_number}; на кнопках показывается только user_order_number.
- Терминальные статусы: Добавлен, Не будет добавлен, Отменена пользователем — заявки в них недоступны для редактирования.

3. Пользовательский поток (FSM OrderStates)
- Создание: product → brand → size → comment/photo → preview → confirm.
- Редактирование: выбор поля (Товар, Бренд, Размер, Комментарий) → ввод → preview → confirm.
- Ответ на вопрос админа: вопрос → пользователь шлёт текст → превью с «Отправить»/«Исправить» → цикл исправлений до подтверждения.
- Любые внеочередные сообщения: ответ с просьбой пользоваться кнопками.

4. Админ-функции
- Отчёты: выгрузка XLSX (полный/рабочий), выпадающие статусы, колонка «Вид» с валидацией, условное форматирование по статусам.
- Массовое обновление статусов: загрузка XLSX → обновление orders → лог в order_status_logs → уведомления пользователям.
- Push-рассылка: ввод ID, текст, предпросмотр, отправка.
- Вопрос пользователю: ввод ID заявки → макрос или свой текст → отправка.
- Админ-настройки: управление администраторами, макросами, словарём видов (кнопка «Вид» → добавить/удалить слово).

5. Распознавание вида (kind)
- kind_keywords: keyword в lowercase, уникален глобально; kind ∈ {Одежда, Обувь, Инвентарь, Аксессуары}.
- Отчёты: guess_kind по словарю из БД, fallback на дефолтные ключи; столбец «Вид» валидируется скрытым справочником.
- UI: карточка вида показывает слова; при добавлении проверяем, что слово не используется в другом виде.

6. Метрики и логирование
- Prometheus на порту 9000 (bot/metrics.py).
- История статусов: order_status_logs, добавляется при создании и смене статуса; ts = UTC.

7. Конфиг и запуск
- .env: BOT_TOKEN, DATABASE_DSN, ADMINS, PHOTOS_DIR, TMP_DIR, PHOTO_CDN_BASE.
- Запуск: python main.py (импорт bot/app.py, dp.start_polling()).
- Docker: Dockerfile, docker-compose.yml (Postgres + бот).

8. Отчёты (bot/services/reports.py)
- Файлы: «Все заказы …xlsx», «В работе …xlsx».
- Колонки: ID заказа, ID пользователя, Статус, Дата создания, Товар, Вид, Бренд, Размер, Комментарий, Фото (локально), Ссылки на фото, Ссылка на товар, Общение, Внутренние комментарии.
- Валидация: статус/вид из скрытых листов; условное форматирование по статусу (приглушённые цвета).

9. Клавиатуры/меню
- main_kb: Оставить заявку, Мои заявки, Как это работает; для админов — Отчёты, Изменить статус, Вопрос пользователю, Push, Админ-настройки, Аналитика.
- Карточка заявки: «К моим заявкам», «Главное меню»; при доступности — «Изменить», «Удалить».

10. BI/SLA подсказка
- Среднее время в статусе считать по order_status_logs через LEAD(ts) OVER (PARTITION BY order_id ORDER BY ts) и усреднение разниц.
